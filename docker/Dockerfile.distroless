# ===========================================================================
# STAGE 1: æ„å»ºé˜¶æ®µ
# ===========================================================================
FROM python:3.11-slim-bookworm AS builder

WORKDIR /app

ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1

# 1. å®‰è£…ä¾èµ–
COPY requirements.txt .
RUN pip install --no-cache-dir --prefix=/install -r requirements.txt

# 2. å¤åˆ¶é¡¹ç›®ä»£ç 
COPY . .

# 3. åœ¨æ„å»ºé˜¶æ®µé¢„æ”¶é›†é™æ€æ–‡ä»¶ (Distroless é•œåƒé‡Œæ²¡æœ‰ shellï¼Œæ— æ³•ä»¥åå†è·‘)
ENV PYTHONPATH=/install/lib/python3.11/site-packages
RUN python manage.py collectstatic --noinput


# ===========================================================================
# STAGE 2: è¿è¡Œé˜¶æ®µ
# ===========================================================================
FROM gcr.io/distroless/python3-debian12

WORKDIR /app

# ä» builder æ‹·è´æ‰€æœ‰çš„ Python åº“å¹¶æ”¾ç½®åœ¨æ ‡å‡†çš„ /usr/local
COPY --from=builder /install /usr/local
# æ‹·è´æ‰€æœ‰é¡¹ç›®ä»£ç å’Œé™æ€èµ„æº
COPY --from=builder /app /app

# ç”Ÿäº§ç¯å¢ƒç¯å¢ƒå˜é‡é…ç½®
ENV PYTHONPATH=/app:/usr/local/lib/python3.11/site-packages \
    DJANGO_SETTINGS_MODULE=AccountBooks.settings \
    PYTHONUNBUFFERED=1 \
    DJANGO_DEBUG=False

# æš´éœ²ç«¯å£
EXPOSE 8000

# ğŸŒŸ æ ¸å¿ƒï¼šDistroless æ²¡æœ‰ä»»ä½• shell (sh/bash)
# ç›´æ¥ç”¨ python3 å¯åŠ¨ launcher_distroless.pyï¼Œå®Œæˆæ•°æ®åº“è¿ç§»å¹¶è°ƒèµ· Gunicorn
ENTRYPOINT ["/usr/bin/python3", "/app/docker/launcher_distroless.py"]
