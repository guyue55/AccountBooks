{% extends "base.html" %}

{% block title %}交易记录 - AccountBooks{% endblock %}
{% block content %}
<header class="page-header">
  <div>
    <h1>交易记录</h1>
    <p>查看并管理所有的商品交易记录。</p>
  </div>
  <div style="display: flex; gap: 0.75rem;">
    <a href="{% url 'export_orders' %}" class="btn btn-secondary">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
        stroke-linecap="round" stroke-linejoin="round" style="margin-right: 6px;">
        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
        <polyline points="7 10 12 15 17 10"></polyline>
        <line x1="12" y1="15" x2="12" y2="3"></line>
      </svg>
      导出 CSV
    </a>
    <button class="btn btn-primary" onclick="openModal('{% url 'order_add' %}')">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
        stroke-linecap="round" stroke-linejoin="round" style="margin-right: 6px;">
        <line x1="12" y1="5" x2="12" y2="19"></line>
        <line x1="5" y1="12" x2="19" y2="12"></line>
      </svg>
      新增记录
    </button>
  </div>
</header>
<!-- 极简单行筛选 -->
<!-- 极简单行筛选 -->
<form method="get" class="filter-toolbar" id="filterForm">
  <!-- 搜索 -->
  <div class="filter-item filter-item-search">
    <svg class="filter-icon" width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="margin-left: 10px;
                  opacity: 0.6">
      <circle cx="11" cy="11" r="8"></circle>
      <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
    </svg>
    <input type="text" name="q" placeholder="搜索人名/商品..." class="filter-item-input">
  </div>
  <!-- 状态 -->
  <div class="filter-item" style="min-width: 120px;">
    <svg class="filter-icon" width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="margin-left: 10px;
                  opacity: 0.6">
      <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
      <polyline points="22 4 12 14.01 9 11.01"></polyline>
    </svg>
    <select name="status" class="filter-item-input" id="statusFilter" onchange="this.form.submit()"
      style="padding-left: 8px">
      <option value="">状态: 全部</option>
      <option value="ok">已还</option>
      <option value="wait">待还</option>
      <option value="default">异常</option>
    </select>
  </div>
  <!-- 日期范围 -->
  <div class="filter-date-group">
    <svg class="filter-icon" width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="opacity:0.6;
                  margin-right:4px">
      <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
      <line x1="16" y1="2" x2="16" y2="6"></line>
      <line x1="8" y1="2" x2="8" y2="6"></line>
      <line x1="3" y1="10" x2="21" y2="10"></line>
    </svg>
    <input type="date" name="start_date" class="filter-item-input"
      onmousedown="event.preventDefault(); this.showPicker()" onclick="this.showPicker()" placeholder="起始">
    <span class="filter-date-separator">至</span>
    <input type="date" name="end_date" class="filter-item-input" onmousedown="event.preventDefault(); this.showPicker()"
      onclick="this.showPicker()" placeholder="结束">
  </div>
  <!-- 操作按钮组 (右侧对齐) -->
  <!-- 操作按钮组 (紧跟在后面) -->
  <div class="filter-actions" style="display: flex; gap: 8px;">
    <button type="submit" class="btn-filter-icon btn-filter-submit" data-tooltip="筛选">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
        stroke-linecap="round" stroke-linejoin="round">
        <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon>
      </svg>
    </button>
  </div>
</form>

<!-- 批量操作栏 -->
<div id="batchActionBar"
  style="display: none; justify-content: space-between; align-items: center; padding: 12px 20px; background: rgba(99, 102, 241, 0.1); border: 1px solid rgba(99, 102, 241, 0.2); border-radius: 8px; margin-bottom: 1rem;">
  <span style="color: var(--text-main); font-size: 0.95rem;">已选择 <span id="selectedCount"
      style="font-weight: bold; color: var(--primary-color);">0</span> 项</span>
  <div style="display: flex; gap: 10px;">
    <button class="btn btn-secondary"
      style="background: rgba(16, 185, 129, 0.1); color: var(--accent-green); border-color: rgba(16, 185, 129, 0.2);"
      onclick="batchUpdateStatus('ok')">
      批量标记已还
    </button>
    <button class="btn btn-danger" onclick="confirmBatchDelete()">批量删除</button>
  </div>
</div>

<div class="table-container">
  <table>
    <thead>
      <tr>
        <th style="width: 40px; text-align: center;"><input type="checkbox" id="selectAllOrders"
            style="accent-color: var(--primary-color); width: 16px; height: 16px; cursor: pointer;"></th>
        <th class="col-id">ID</th>
        <th style="width: 100px;">顾客</th>
        <th>商品明细</th>
        <th>应收总价</th>
        <th>实收总价</th>
        <th style="width: 60px;" class="status-col">状态</th>
        <th>交易时间</th>
        <th style="width: 100px;">操作</th>
      </tr>
    </thead>
    <tbody>
      {% for order in orders %}
      <tr>
        <td style="text-align: center;"><input type="checkbox" class="order-checkbox" value="{{ order.id }}"
            style="accent-color: var(--primary-color); width: 16px; height: 16px; cursor: pointer;"></td>
        <td class="col-id" style="color: var(--text-dim);">{{ order.id }}</td>
        <td style="font-weight: 500;">{{ order.account.name }}</td>
        <td>
          <div class="text-truncate-wrapper">
            <!-- 悬停显示的详细 HTML 内容 -->
            <div class="tooltip-content">
              {% for item in order.items.all %}
              <div style="white-space: nowrap;">
                <span style="color: var(--text-main);">{{ item.goods.goods }}</span>
                <span style="color: var(--text-dim);">× {{ item.quantity }}</span>
                <span style="color: var(--accent-green); font-weight: 600;">= ¥{{ item.subtotal }}</span>
              </div>
              {% endfor %}
            </div>
            <!-- 默认显示的精简内容 -->
            <div class="text-truncate-container">
              {% for item in order.items.all %}
              <div style="font-size: 0.8125rem;
                                color: var(--text-dim);
                                line-height: 1.6">
                <span style="color: var(--text-main);">{{ item.goods.goods }}</span>
                × {{ item.quantity }}
              </div>
              {% empty %}
              <span style="color: var(--text-dim); font-size: 0.8125rem;">-</span>
              {% endfor %}
            </div>
          </div>
        </td>
        <td style="font-weight: 800;">¥{{ order.total_price }}</td>
        <td style="color: var(--accent-green);">¥{{ order.total_price_real }}</td>
        <td class="status-col">
          <span class="status-badge status-{{ order.status }}">{{ order.get_status_display }}</span>
        </td>
        <td style="color: var(--text-dim); font-size: 0.875rem;">{{ order.buy_time|date:"Y-m-d H:i" }}</td>
        <td>
          <div class="action-group">
            <button class="action-link action-link-edit"
              onclick="openModal('{% url 'order_edit' order.pk %}')">编辑</button>
            <button class="action-link action-link-delete"
              onclick="confirmDelete('{% url 'order_delete' order.pk %}', '订单 {{ order.id }} ({{ order.account.name }})')">
              删除
            </button>
          </div>
        </td>
      </tr>
      {% empty %}
      <tr>
        <td colspan="9">
          <div class="empty-state">
            <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"
              stroke-linecap="round" stroke-linejoin="round"
              style="color: var(--text-dim); margin-bottom: 1rem; opacity: 0.5;">
              <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
              <line x1="3" y1="9" x2="21" y2="9"></line>
              <line x1="9" y1="21" x2="9" y2="9"></line>
            </svg>
            <p style="font-size: 1.1rem; color: var(--text-main); font-weight: 500;">暂无交易记录</p>
            <p
              style="margin-top: 0.5rem; color: var(--text-dim); font-size: 0.875rem; max-width: 250px; margin-left: auto; margin-right: auto;">
              您还没有添加任何交易订单，点击下方按钮开始记账。</p>
            <button class="btn btn-primary" style="margin-top: 1.25rem; font-size: 0.85rem;"
              onclick="openModal('{% url 'order_add' %}')">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
              </svg>
              新增第一笔交易
            </button>
          </div>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% if is_paginated %}
  <div class="pagination">
    {% if page_obj.has_previous %}
    <a href="?page={{ page_obj.previous_page_number }}{% if query_string %}&{{ query_string }}{% endif %}">&laquo;</a>
    {% endif %}
    <span class="current">{{ page_obj.number }} / {{ page_obj.paginator.num_pages }}</span>
    {% if page_obj.has_next %}
    <a href="?page={{ page_obj.next_page_number }}{% if query_string %}&{{ query_string }}{% endif %}">&raquo;</a>
    {% endif %}
  </div>
  {% endif %}
</div>
{% endblock %}
{% block extra_js %}
<script>
  // 页面加载后，根据 URL 参数自动恢复筛选表单的状态
  document.addEventListener('DOMContentLoaded', function () {
    const urlParams = new URLSearchParams(window.location.search);

    // 恢复搜索框
    const q = urlParams.get('q');
    if (q) document.querySelector('input[name="q"]').value = q;

    // 恢复状态下拉框
    const status = urlParams.get('status');
    if (status) {
      const statusEl = document.getElementById('statusFilter');
      if (statusEl) statusEl.value = status;
    }

    // 恢复日期
    const startDate = urlParams.get('start_date');
    if (startDate) document.querySelector('input[name="start_date"]').value = startDate;

    const endDate = urlParams.get('end_date');
    if (endDate) document.querySelector('input[name="end_date"]').value = endDate;
  });
</script>
{% endblock %}