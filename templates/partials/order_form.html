{% load static %}
<!-- 订单表单 Modal 片段 —— 新增/编辑复用，含 OrderItem formset -->
<div class="modal-header">
    <h2>{{ title|default:"新增交易记录" }}</h2>
    <button class="modal-close" onclick="closeModal()" type="button">&times;</button>
</div>
<div class="modal-body">
    <form method="post" id="orderForm"
        action="{% if is_edit %}{% url 'order_edit' object.pk %}{% else %}{% url 'order_add' %}{% endif %}"
        onsubmit="submitModalForm(event); return false;">
        {% csrf_token %}

        <!-- 购买人选择 + 快速新增 -->
        <div class="form-group required">
            <label for="{{ form.account.id_for_label }}">{{ form.account.label }}</label>
            <div class="input-with-action">
                {{ form.account }}
                <button type="button" class="btn-quick-add" title="快速新增购买人"
                    onclick="openModal('{% url 'customer_add' %}', 2)">+</button>
            </div>
            {% if form.account.errors %}
            <div class="form-error">{{ form.account.errors.0 }}</div>
            {% endif %}
        </div>

        <!-- 商品行项 -->
        <div class="form-group">
            <label>商品明细</label>
            {{ formset.management_form }}
            <table class="order-items-table" id="orderItemsTable">
                <thead>
                    <tr>
                        <th style="width: 40%;">商品</th>
                        <th style="width: 20%;">数量</th>
                        <th style="width: 25%;">单价</th>
                        <th style="width: 15%;"></th>
                    </tr>
                </thead>
                <tbody id="orderItemsBody">
                    {% for item_form in formset %}
                    <tr class="order-item-row">
                        {% if item_form.instance.pk %}
                        <input type="hidden" name="{{ item_form.prefix }}-id" value="{{ item_form.instance.pk }}">
                        {% endif %}
                        <td>
                            <div class="input-with-action">
                                {{ item_form.goods }}
                                <button type="button" class="btn-quick-add" title="快速新增商品"
                                    onclick="openModal('{% url 'goods_add' %}', 2)"
                                    style="width: 32px; height: 32px; font-size: 1rem;">+</button>
                            </div>
                            {% if item_form.goods.errors %}
                            <div class="form-error">{{ item_form.goods.errors.0 }}</div>
                            {% endif %}
                        </td>
                        <td>
                            {{ item_form.quantity }}
                            {% if item_form.quantity.errors %}
                            <div class="form-error">{{ item_form.quantity.errors.0 }}</div>
                            {% endif %}
                        </td>
                        <td>
                            {{ item_form.unit_price }}
                        </td>
                        <td style="text-align: center; vertical-align: middle;">
                            <div style="display: none;">{{ item_form.DELETE }}</div>
                            <button type="button" class="btn-remove-row" onclick="removeItemRow(this)"
                                data-tooltip="移除此行">✕</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            <button type="button" class="btn-add-row" onclick="addItemRow()">+ 添加商品行</button>
        </div>

        <!-- 应收总价（自动计算，只读） -->
        <div class="total-display" id="totalDisplay">
            应收总价：<span>¥ 0.00</span>
        </div>

        <!-- 实收金额 -->
        <div class="form-group">
            <label for="{{ form.total_price_real.id_for_label }}">{{ form.total_price_real.label }}</label>
            {{ form.total_price_real }}
            {% if form.total_price_real.errors %}
            <div class="form-error">{{ form.total_price_real.errors.0 }}</div>
            {% endif %}
        </div>

        <!-- 还款状态 -->
        <div class="form-group required">
            <label for="{{ form.status.id_for_label }}">{{ form.status.label }}</label>
            {{ form.status }}
            {% if form.status.errors %}
            <div class="form-error">{{ form.status.errors.0 }}</div>
            {% endif %}
        </div>

        <div class="modal-btn-group">
            <button type="button" class="btn btn-secondary" onclick="closeModal()">取消</button>
            <button type="submit" class="btn btn-primary">保存</button>
        </div>
    </form>
</div>

<script>
    (function () {
        /**
         * 获取当前 formset 的总表单数量。
         */
        function getTotalForms() {
            return parseInt(document.getElementById('id_items-TOTAL_FORMS').value);
        }

        /**
         * 设置 formset 总表单数量。
         */
        function setTotalForms(count) {
            document.getElementById('id_items-TOTAL_FORMS').value = count;
        }

        /**
         * 添加新的商品行。
         * 复制第一行的 HTML 结构，重置索引和值。
         */
        window.addItemRow = function () {
            const tbody = document.getElementById('orderItemsBody');
            const totalForms = getTotalForms();

            // 取第一行作为模板（如果存在）
            const firstRow = tbody.querySelector('.order-item-row');
            if (!firstRow) return;

            const newRow = firstRow.cloneNode(true);
            // 更新所有 input/select 的 name 和 id 属性中的索引
            const elements = newRow.querySelectorAll('input, select');
            elements.forEach(el => {
                if (el.name) {
                    el.name = el.name.replace(/items-\d+/, `items-${totalForms}`);
                }
                if (el.id) {
                    el.id = el.id.replace(/items-\d+/, `items-${totalForms}`);
                }
                // 重置值
                if (el.type === 'number') {
                    el.value = el.name.includes('quantity') ? '1' : '';
                } else if (el.type === 'hidden' && el.name.includes('-id')) {
                    el.remove(); // 移除 id hidden field
                } else if (el.tagName === 'SELECT') {
                    el.selectedIndex = 0;
                } else if (el.type === 'checkbox') {
                    el.checked = false;
                }
            });

            // 清除错误消息
            newRow.querySelectorAll('.form-error').forEach(e => e.remove());

            tbody.appendChild(newRow);
            setTotalForms(totalForms + 1);
            bindPriceEvents();
        };

        /**
         * 移除商品行。
         * 如果行有 DELETE checkbox，则标记为删除而非直接移除 DOM。
         */
        window.removeItemRow = function (btn) {
            const row = btn.closest('.order-item-row');
            const deleteCheckbox = row.querySelector('input[type="checkbox"][name*="DELETE"]');
            if (deleteCheckbox) {
                // 已有记录，标记为删除并隐藏行
                deleteCheckbox.checked = true;
                row.style.display = 'none';
                row.classList.remove('order-item-row'); // 移除类名以免被 calcTotal 再次统计
            } else {
                // 新行，直接移除
                row.remove();
                renumberRows();
            }
            calcTotal();
        };

        /**
         * 重新编号所有行的 formset 索引。
         */
        function renumberRows() {
            const rows = document.querySelectorAll('#orderItemsBody .order-item-row');
            let visibleIndex = 0;
            rows.forEach((row, idx) => {
                const elements = row.querySelectorAll('input, select');
                elements.forEach(el => {
                    if (el.name) {
                        el.name = el.name.replace(/items-\d+/, `items-${idx}`);
                    }
                    if (el.id) {
                        el.id = el.id.replace(/items-\d+/, `items-${idx}`);
                    }
                });
            });
            setTotalForms(rows.length);
        }

        /**
         * 计算所有行的应收总价。
         */
        function calcTotal() {
            let total = 0;
            const rows = document.querySelectorAll('#orderItemsBody .order-item-row');
            rows.forEach(row => {
                if (row.style.display === 'none') return; // 跳过已标记删除的行
                const priceInput = row.querySelector('input[name*="unit_price"]');
                const qtyInput = row.querySelector('input[name*="quantity"]');
                const price = parseFloat(priceInput?.value) || 0;
                const qty = parseInt(qtyInput?.value) || 0;
                total += price * qty;
            });
            const display = document.getElementById('totalDisplay');
            if (display) {
                display.innerHTML = `应收总价：<span>¥ ${total.toFixed(2)}</span>`;
            }

            // 同步实收金额（如果用户还未手动修改过，或者当前是新增模式）
            const realPriceInput = document.getElementById('id_total_price_real');
            if (realPriceInput && !realPriceInput._manuallyEdited) {
                realPriceInput.value = total.toFixed(2);
            }
        }

        /**
         * 当商品选择变化时，自动填充单价。
         */
        function onGoodsChange(selectEl) {
            const goodsId = selectEl.value;
            const row = selectEl.closest('.order-item-row');
            if (!row) return;
            const priceInput = row.querySelector('input[name*="unit_price"]');

            if (!goodsId) {
                if (priceInput) priceInput.value = '0.00';
                calcTotal();
                return;
            }

            // 检查重复
            const existingSelects = document.querySelectorAll('select[name*="goods"]');
            let duplicate = false;
            existingSelects.forEach(s => {
                if (s !== selectEl && s.value === goodsId) {
                    const r = s.closest('.order-item-row');
                    if (r && r.style.display !== 'none') {
                        duplicate = true;
                    }
                }
            });

            if (duplicate) {
                showToast('该商品已在列表中，请勿重复添加', 'error');
                selectEl.value = '';
                if (priceInput) priceInput.value = '0.00';
                calcTotal();
                return;
            }

            fetch(`/api/calc-price?goods_id=${goodsId}`, {
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            })
                .then(r => r.json())
                .then(data => {
                    if (priceInput) {
                        priceInput.value = data.unit_price || '0.00';
                        // 触发 input 事件以更新总价
                        priceInput.dispatchEvent(new Event('input'));
                    }
                })
                .catch(() => {
                    if (priceInput) priceInput.value = '0.00';
                    calcTotal();
                });
        }

        /**
         * 绑定所有行的商品选择和数量变化事件。
         */
        function bindPriceEvents() {
            document.querySelectorAll('#orderItemsBody .order-item-row').forEach(row => {
                const goodsSelect = row.querySelector('select[name*="goods"]');
                const qtyInput = row.querySelector('input[name*="quantity"]');
                const priceInput = row.querySelector('input[name*="unit_price"]');

                if (goodsSelect && !goodsSelect._bound) {
                    goodsSelect.addEventListener('change', function () { onGoodsChange(this); });
                    goodsSelect._bound = true;
                }
                if (qtyInput && !qtyInput._bound) {
                    qtyInput.addEventListener('input', calcTotal);
                    qtyInput._bound = true;
                }
                if (priceInput && !priceInput._bound) {
                    priceInput.addEventListener('input', calcTotal);
                    priceInput._bound = true;
                }
            });
        }

        // 初始化
        bindPriceEvents();
        calcTotal();

        // 监听实收金额的手动修改
        const realPriceInput = document.getElementById('id_total_price_real');
        if (realPriceInput) {
            realPriceInput.addEventListener('input', function () {
                this._manuallyEdited = true;
            });
        }

        // 监听 entity-created 事件（来自 Quick Add）
        // 使用全局变量确保同一时间只有一个有效的监听器处理当前表单
        if (window.currentEntityCreatedHandler) {
            document.removeEventListener('entity-created', window.currentEntityCreatedHandler);
        }

        window.currentEntityCreatedHandler = function (e) {
            const data = e.detail;
            if (data.id && data.text) {
                // 1. 尝试添加到购买人下拉框
                const accountSelect = document.getElementById('id_account');
                if (accountSelect) {
                    let exists = false;
                    for (let i = 0; i < accountSelect.options.length; i++) {
                        if (accountSelect.options[i].value == data.id) {
                            exists = true;
                            break;
                        }
                    }
                    // 如果不存在，且看起来像是 Account 数据（通常 quick add 都是为了当前 form）
                    // 实际上我们无法严格区分数据类型，但添加一个不匹配的 option 在 UI 上也不致命（用户选了发现不对）
                    // 更好的方式是后端返回 model_name，但现在先简化处理：
                    // 如果是 QuickAdd 触发的，通常用户刚刚在 Modal2 里加了。
                    // 假设用户加了 Purchase (Account)，我们加到 Account Select。
                    // 假设用户加了 Goods，我们加到 Goods Select。

                    if (!exists) {
                        const option = new Option(data.text, data.id, true, true);
                        accountSelect.add(option);
                        accountSelect.dispatchEvent(new Event('change'));
                        // 如果成功添加并选中，提示用户
                        // showToast(`已自动选择: ${data.text}`, 'info');
                    }
                }

                // 2. 尝试添加到所有商品下拉框
                const goodsSelects = document.querySelectorAll('select[name*="goods"]');
                if (goodsSelects.length > 0) {
                    goodsSelects.forEach(select => {
                        let exists = false;
                        for (let i = 0; i < select.options.length; i++) {
                            if (select.options[i].value == data.id) {
                                exists = true;
                                break;
                            }
                        }
                        if (!exists) {
                            // 仅添加选项，不自动选中（因为可能有多个行，不知道用户想加到哪一行）
                            // 除非是空行？
                            const option = new Option(data.text, data.id, false, false);
                            select.add(option);
                        }
                    });
                }
            }
        };

        document.addEventListener('entity-created', window.currentEntityCreatedHandler);
    })();
</script>